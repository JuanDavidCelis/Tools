#!/usr/bin/env bash

# ==============================
# Configuraci칩n
# ==============================
API_TOKEN="xxxxxxxx"
API_URL="https://ipinfo.io"


# ==============================
# Obtener entrada (argumentos o pipe)
# ==============================
if [ -t 0 ]; then
  INPUT="$*"
else
  INPUT="$(cat)"
fi

if [ -z "$INPUT" ]; then
  echo "Uso:"
  echo "checkip 8.8.8.8 1.1.1.1"
  echo "echo '8.8.8.8 # fecha' | checkip"
  exit 1
fi

# ==============================
# Extraer IPs v치lidas
# ==============================
IPS=$(echo "$INPUT" | grep -Eo '([0-9]{1,3}\.){3}[0-9]{1,3}' | sort -u)

if [ -z "$IPS" ]; then
  echo "No se encontraron IPs v치lidas."
  exit 1
fi

# ==============================
# Consultar API
# ==============================
for ip in $IPS; do
  printf "\n游댍 %s\n" "$ip"

  response=$(curl -s --max-time 5 \
    "$API_URL/$ip?token=$API_TOKEN")

  if echo "$response" | grep -q '"bogon":'; then
    echo "IP privada / reservada"
    continue
  fi

  if echo "$response" | grep -q '"error"'; then
    echo "Error consultando API"
    continue
  fi

  echo "$response" | jq -r '
    "Pa칤s: " + (.country // "N/A") +
    " | Regi칩n: " + (.region // "N/A") +
    " | Ciudad: " + (.city // "N/A") +
    " | Org: " + (.org // "N/A")'
done
